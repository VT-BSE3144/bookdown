---
output: html_document
params:
  version: 1.0
---

# Interpolation and Extrapolation Examples {.unnumbered}

```{r setup}
# Set global chunk options and load necessary libraries
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)      # for plotting
library(tidyverse)    # for data manipulation and piping
library(PolynomF)     # for polynomial fitting functions
library(pracma)       # for numerical tools, not used directly here
```

## Example - CO~2~ at Mana Loa Observatory

The Mauna Loa Observatory contains the longest *in situ* record of CO~2~ in the atmosphere. This dataset is ideal for demonstrating interpolation and extrapolation methods.

>  **Interpolation**: Estimating values within known data range.  
>  **Extrapolation**: Predicting values beyond known data range.

Let's read in this data and start by visualizing it.

```{r}
# Define column names and read in the dataset, skipping comments
coln <- c("year","co2","y")
mana_loa_co2 <- read_delim("data/co2_annmean_mlo.txt",delim = "   ", comment = "#",col_names = coln)

# Convert columns to numeric types
mana_loa_co2$year <- as.numeric(mana_loa_co2$year)
mana_loa_co2$co2 <- as.numeric((mana_loa_co2$co2))

# Plot the raw data to see the trend
plot(mana_loa_co2$year, mana_loa_co2$co2)
```

### Linear Extrapolation
Let's build a linear model and extrapolate to the year 2100.

**Pros:**
- Simple and interpretable
- Quick to compute

**Cons:**
- Assumes constant trend (which may be invalid for long-term projection)
- Often underestimates curved growth

```{r}
# Fit a linear model to the entire dataset
lm_co2 <- lm(co2 ~ year, data = mana_loa_co2)

# Create a new tibble of years to predict
pred_co2 <- 
  tibble(year = seq(1970, 2100, 1)) |>  # sequence of years
  mutate(lm_pred_co2 = predict(lm_co2, pick(year)))  # predict CO2 values using the model
```

### Manual Linear Extrapolation (Last 2 Points)

**Pros:**
- Reflects the most recent trend in the data
- Very simple and intuitive

**Cons:**
- Ignores all historical trends
- Can be overly sensitive to short-term noise

```{r}
# Define a simple linear interpolation/extrapolation function
lin_interp <- function(fx1,fx2,x1,x2,x3) fx1+((fx2-fx1)/(x2-x1))*(x3-x1)

# Grab the last two rows of data
lin_extrap_data <- tail(mana_loa_co2, n = 2)

# Apply manual extrapolation to estimate CO2 in 2100
lin_interp(fx1 = lin_extrap_data[[1,"co2"]],
           fx2 = lin_extrap_data[[2,"co2"]], 
           x1 = lin_extrap_data[[1,"year"]],
           x2 = lin_extrap_data[[2,"year"]], 
           x3 = 2100)

# Fit a new linear model using just the last two points
lm2_co2 <- lm(co2 ~ year, data = lin_extrap_data)
```

### Polynomial Fit

**Pros:**
- Can capture curvature and nonlinear patterns
- Flexible with low-degree models

**Cons:**
- High-degree polynomials often overfit and behave wildly when extrapolating
- Sensitive to data irregularities and outliers

```{r}
# Use poly_calc to fit a high-order polynomial to the data
year_pred <- seq(1970, 2100)
co2_poly <- poly_calc(mana_loa_co2$year, mana_loa_co2$co2)

# Evaluate the polynomial at the prediction years
mana_loa_co2_pred <- data.frame(year = year_pred, co2_poly = co2_poly(year_pred))

# Plot the high-degree polynomial fit
co2_plot + geom_line(data = mana_loa_co2_pred, mapping = aes(x = year, y = co2_poly))
```

```{r}
# Fit a more controlled polynomial model (6th degree)
m3 <- lm(co2 ~ poly(x = year, degree = 6, raw = TRUE), data = mana_loa_co2)
summary(m3)

# Predict values from the new model
mana_loa_co2_pred$co2_m3 <- 
  m3 %>% predict(mana_loa_co2_pred) 

# Plot the model's predictions
co2_plot + geom_line(data = mana_loa_co2_pred, mapping = aes(x = year, y = co2_m3))
```

### Smoother Polynomial: `stat_smooth`

Useful for adding fitted curves and confidence bands to plots.

**Pros:**
- Cleaner visualization
- Confidence intervals automatically calculated

**Cons:**
- Less control over extrapolation behavior

```{r}
ggplot(data = mana_loa_co2,
    aes(x = year, y = co2)) +
  geom_point(size = 1) + 
  stat_smooth(method = lm, formula = y ~ poly(x = x, degree = 3, raw = TRUE), 
              fullrange = TRUE) + 
  xlim(1959, 2100)
```

### Spline Fitting

**Pros:**
- Captures local trends better than global polynomials
- More stable and flexible

**Cons:**
- Risk of overfitting if not carefully tuned
- May be harder to interpret

```{r}
# Use splines to fit a curve to the data
library(splines)
m_splines <- lm(co2 ~ splines::bs(year, knots = mana_loa_co2$co2), data = mana_loa_co2)

# Predict using the spline model
mana_loa_co2_pred$co2_m_splines <- 
  m_splines %>% predict(mana_loa_co2_pred) 

# Plot spline predictions
co2_plot + geom_line(data = mana_loa_co2_pred, mapping = aes(x = year, y = co2_m_splines))
```

```{r}
# Show predicted CO2 at year 2100 using spline model
mana_loa_co2_pred %>% tail(n=1)
```

```{r}
# Visualize spline prediction using stat_smooth
ggplot(data = mana_loa_co2,
    aes(x = year, y = co2)) +
  geom_point(size = 1) + 
  stat_smooth(method = lm, formula = y ~ bs(x = x, knots = mana_loa_co2$co2), 
              fullrange = TRUE) + 
  xlim(1959, 2100)
```
